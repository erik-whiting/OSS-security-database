from db.database import Query

class RepoVulnerability:
  def __init__(self, repo, vulnerability):
    self.repo = repo
    self.repo_commit_analyzed = repo.get_latest_commit()
    self.vulnerability = vulnerability
    self.equivalent_cwe_id = None

  def find_equivalent_cve(self):
    q = Query()
    cwes = q.get_like('common_weakness_enumerations', 'name', self.vulnerability)
    if len(cwes) > 0:
      self.equivalent_cwe_id = cwes[0][0]

  def insert(self):
    self.find_equivalent_cve()
    columns = [
      'repository_id',
      'latest_commit_analyzed',
      'name_of_vulnerability'
    ]
    
    insertable_vulnerability = self.vulnerability.replace('\'', '\'\'')
    insert_values = [
      self.repo.id,
      f"'{self.repo_commit_analyzed}'",
      f"'{insertable_vulnerability}'"
    ]
    
    if self.equivalent_cwe_id:
      columns.append('equivalent_cwe_id')
      insert_values.append(self.equivalent_cwe_id)
    
    q = Query()
    q.insert(
      'repo_vulnerabilities',
      columns,
      insert_values
    )
